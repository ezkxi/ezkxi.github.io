
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üåç Trash Points Leaderboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      background: url("image.jpg") no-repeat center center fixed;
      background-size: cover;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease, color 0.3s ease;
      position: relative;
    }
    body::before { content:""; position:absolute; inset:0; z-index:-1; }
    .main-card { border-radius:1rem; max-width:1000px; width:100%; }
    body.dark-mode::before { background:rgba(0,0,0,0.6); }
    .dark-mode .card { background-color:#2c2c3e!important; color:#f8f9fa; }
    .dark-mode .table { color:#f8f9fa; }
    .dark-mode .table-warning { background-color:#665c00!important; color:#fff!important; }
    .action-btn { cursor:pointer; margin-left:6px; }
  </style>
</head>
<body>

  <div class="card shadow-lg main-card">
    <div class="card-body p-4">

      <!-- Header -->
      <div class="d-flex flex-column flex-md-row align-items-center mb-4 gap-2">
        <h1 class="h4 fw-bold text-primary mb-0">üåç Trash Points Leaderboard</h1>
        <div class="d-flex gap-2 ms-md-auto">
          <button id="refreshBtn" class="btn btn-outline-primary btn-sm d-flex align-items-center" title="Reload leaderboard">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <button id="loginBtn" class="btn btn-outline-warning btn-sm d-flex align-items-center" title="Admin Login">
            <i class="bi bi-person-lock"></i>
          </button>
          <button id="themeToggle" class="btn btn-outline-secondary btn-sm d-flex align-items-center" title="Toggle Light/Dark">
            <i class="bi bi-moon"></i>
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="row text-center mb-4">
        <div class="col">
          <div class="card shadow-sm"><div class="card-body">
            <div class="small text-muted">Participants</div>
            <div id="statParticipants" class="fs-5 fw-bold">‚Äî</div>
          </div></div>
        </div>
        <div class="col">
          <div class="card shadow-sm"><div class="card-body">
            <div class="small text-muted">Total Points</div>
            <div id="statTotalPoints" class="fs-5 fw-bold">‚Äî</div>
          </div></div>
        </div>
      </div>

      <!-- Leaderboard -->
      <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold">Leaderboard</span>
          <div class="input-group input-group-sm" style="width:auto; max-width:300px;">
            <input type="text" id="searchBox" class="form-control" placeholder="Search...">
            <button id="toggleView" class="btn btn-success">
              <i class="bi bi-people-fill me-1"></i> By Section
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="leaderboardTable">
              <thead>
                <tr id="tableHeader">
                  <th>Rank</th>
                  <th>Name</th>
                  <th>Section</th>
                  <th>Grade</th>
                  <th>Points</th>
                  <th class="admin-col d-none">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <button id="prevPage" class="btn btn-outline-secondary btn-sm" disabled>Previous</button>
        <span id="pageInfo" class="small text-muted"></span>
        <button id="nextPage" class="btn btn-outline-secondary btn-sm">Next</button>
      </div>

      <footer class="text-center text-muted py-3 small mt-4">
        Burandats ‚Ä¢ Smart Trash Bin System
        <div id="lastUpdated" class="small"></div>
      </footer>

    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content shadow">
      <form id="registerForm">
        <div class="modal-header">
          <h5 class="modal-title">Register/Edit Entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="uid">
          <input type="text" id="name" class="form-control mb-2" placeholder="Name" required>
          <input type="text" id="section" class="form-control mb-2" placeholder="Section" required>
          <input type="text" id="grade" class="form-control mb-2" placeholder="Grade" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div></div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content shadow">
      <form id="loginForm">
        <div class="modal-header">
          <h5 class="modal-title">Admin Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="username" class="form-control mb-2" placeholder="Username" required>
          <input type="password" id="password" class="form-control mb-2" placeholder="Password" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">Login</button>
        </div>
      </form>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const BIN_ID = "68d7f447ae596e708ffdc6ec";
    const MASTER_KEY = "$2a$10$sbJRnG/.C1CQIONF.h5qQuB3f1266FBqS3.OMJ0TZfDLwJPkr.DMy"; // your keys here
    const ACCESS_KEY = "$2a$10$6AJKoWpIqGulLRIRVmEPsOFjiUXFNyoQ5LWUBt3ChrXpqaWoriva2";

    let entries = {};
    let currentPage = 1;
    const perPage = 10;
    let viewBySection = false;
    let isAdmin = false;

    async function fetchData() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: { "X-Master-Key": MASTER_KEY, "X-Access-Key": ACCESS_KEY }
      });
      return (await res.json()).record;
    }
    async function saveData(data) {
      await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method:"PUT",
        headers:{
          "Content-Type":"application/json",
          "X-Master-Key":MASTER_KEY,
          "X-Access-Key":ACCESS_KEY
        },
        body:JSON.stringify(data)
      });
    }

    function computeStats(data){
      $("#statParticipants").text(Object.keys(data).length);
      const total=Object.values(data).reduce((s,i)=>s+Number(i.points||0),0);
      $("#statTotalPoints").text(total);
    }

    function renderTable(data){
      const tbody=$("#leaderboardTable tbody");
      const theadRow=$("#tableHeader");
      tbody.empty();

      if(viewBySection){
        // section view
        const sectionTotals={};
        for(const info of Object.values(data)){
          if(!info.section) continue;
          sectionTotals[info.section]=(sectionTotals[info.section]||0)+Number(info.points||0);
        }
        const sorted=Object.entries(sectionTotals).sort((a,b)=>b[1]-a[1]);
        theadRow.html(`<th>Rank</th><th>Section</th><th>Points</th>`);
        sorted.forEach(([sec,tot],i)=>{
          tbody.append(`<tr><td>${i+1}</td><td>${sec}</td><td>${tot}</td></tr>`);
        });
        return;
      }

      // normal participant view
      theadRow.html(`
        <th>Rank</th><th>Name</th><th>Section</th><th>Grade</th><th>Points</th>
        <th class="admin-col ${isAdmin?"":"d-none"}">Actions</th>`);

      const sorted=Object.entries(data).sort((a,b)=>b[1].points-a[1].points);
      const start=(currentPage-1)*perPage;
      const pageData=sorted.slice(start,start+perPage);

      pageData.forEach(([uid,info],i)=>{
        const isUnreg=!(info.name&&info.section&&info.grade);
        tbody.append(`
          <tr class="${isUnreg?"table-warning":""}">
            <td>${start+i+1}</td>
            <td>${info.name||uid}</td>
            <td>${info.section||"‚Äî"}</td>
            <td>${info.grade||"‚Äî"}</td>
            <td>${info.points}</td>
            <td class="admin-col ${isAdmin?"":"d-none"}">
              <i class="bi bi-pencil-square text-primary action-btn edit-btn" data-uid="${uid}" title="Edit"></i>
              <i class="bi bi-trash text-danger action-btn delete-btn" data-uid="${uid}" title="Delete"></i>
            </td>
          </tr>`);
      });
    }

    async function loadLeaderboard(){
      $("#leaderboardTable tbody").html("<tr><td colspan='6'>Loading...</td></tr>");
      entries=await fetchData();
      computeStats(entries);
      renderTable(entries);
      $("#lastUpdated").text("Last updated: "+new Date().toLocaleTimeString());
    }

    $(document).ready(function(){
      loadLeaderboard();

      $("#refreshBtn").click(loadLeaderboard);

      $("#searchBox").on("input",function(){
        const f=$(this).val().toLowerCase();
        const filtered={};
        for(const [uid,info] of Object.entries(entries)){
          if(uid.toLowerCase().includes(f)||
             (info.name&&info.name.toLowerCase().includes(f))||
             (info.section&&info.section.toLowerCase().includes(f))||
             (info.grade&&info.grade.toLowerCase().includes(f))) filtered[uid]=info;
        }
        renderTable(filtered);
      });

      $(document).on("click",".edit-btn",function(){
        const uid=$(this).data("uid");
        const entry=entries[uid]||{};
        $("#uid").val(uid);
        $("#name").val(entry.name||"");
        $("#section").val(entry.section||"");
        $("#grade").val(entry.grade||"");
        $("#registerModal").modal("show");
      });

      $(document).on("click",".delete-btn",async function(){
        if(!confirm("Delete this entry?")) return;
        const uid=$(this).data("uid");
        delete entries[uid];
        await saveData(entries);
        loadLeaderboard();
      });

      $("#registerForm").on("submit",async function(e){
        e.preventDefault();
        const uid=$("#uid").val().trim();
        const existing=entries[uid]?.points||0;
        entries[uid]={
          name:$("#name").val().trim(),
          section:$("#section").val().trim(),
          grade:$("#grade").val().trim(),
          points:existing
        };
        await saveData(entries);
        $("#registerModal").modal("hide");
        loadLeaderboard();
      });

      $("#loginBtn").click(()=>$("#loginModal").modal("show"));

      $("#loginForm").on("submit",function(e){
        e.preventDefault();
        if($("#username").val()==="admin"&&$("#password").val()==="admin"){
          isAdmin=true;
          $("#loginModal").modal("hide");
          renderTable(entries);
        }else{
          alert("Invalid credentials");
        }
      });

      $("#themeToggle").click(function(){
        $("body").toggleClass("dark-mode");
        $(this).find("i").toggleClass("bi-moon bi-sun");
      });

      $("#toggleView").click(function(){
        viewBySection=!viewBySection;
        $(this).html(viewBySection?'<i class="bi bi-person-fill me-1"></i> By Participant':'<i class="bi bi-people-fill me-1"></i> By Section');
        renderTable(entries);
      });
    });
  </script>
</body>
</html>

